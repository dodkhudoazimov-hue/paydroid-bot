import telebot
import requests
import os

# üîπ –¢–æ–∫–µ–Ω“≥–æ–∏ —Ö—É–¥—Ä–æ –≥—É–∑–æ—Ä:
BOT_TOKEN = "8238563485:AAHNLTZodPeXcl7YfjZqIqY6BpcPuP3QGXs"
AUDD_TOKEN = "67bb96ec3f8a31cf3b9a73a4279fbb99"

bot = telebot.TeleBot(BOT_TOKEN)

@bot.message_handler(commands=['start'])
def start(message):
    bot.reply_to(message,
        "–°–∞–ª–æ–º üéß\n–ú–∞–Ω –±–æ—Ç “≥–∞—Å—Ç–∞–º, –∫–∏ –º—É—Å–∏“õ–∏—Ä–æ –º–µ—à–∏–Ω–æ—Å–∞–º!\n"
        "–§–∞“õ–∞—Ç —è–∫ –∞—É–¥–∏–æ —ë voice —Ñ–∏—Ä–∏—Å—Ç, –º–∞–Ω –Ω–æ–º–∏ —Å—É—Ä—É–¥—Ä–æ –º–µ—ë–±–∞–º üéµ"
    )

@bot.message_handler(content_types=['voice', 'audio'])
def recognize_music(message):
    msg = bot.reply_to(message, "‚è≥ –õ—É—Ç—Ñ–∞–Ω –∏–Ω—Ç–∏–∑–æ—Ä —à–∞–≤–µ–¥, —Å—É—Ä—É–¥—Ä–æ –º–µ—à–∏–Ω–æ—Å–∞–º...")

    try:
        # ‚¨áÔ∏è –ì–∏—Ä–∏—Ñ—Ç–∞–Ω–∏ —Ñ–∞–π–ª–∏ –∞—É–¥–∏–æ –∞–∑ Telegram
        file_info = bot.get_file(message.voice.file_id if message.voice else message.audio.file_id)
        downloaded_file = bot.download_file(file_info.file_path)

        temp_path = "temp_audio.ogg"
        with open(temp_path, "wb") as f:
            f.write(downloaded_file)

        # ‚¨ÜÔ∏è –§–∏—Ä–∏—Å—Ç–æ–¥–∞–Ω –±–∞ API-–∏ AudD
        url = "https://api.audd.io/"
        data = {
            'api_token': AUDD_TOKEN,
            'return': 'apple_music,spotify',
        }
        files = {
            'file': open(temp_path, 'rb')
        }
        response = requests.post(url, data=data, files=files)
        result = response.json()

        os.remove(temp_path)

        if result.get("result"):
            song = result["result"]
            title = song.get("title", "–ù–æ–º–∞—ä–ª—É–º")
            artist = song.get("artist", "–ù–æ–º–∞—ä–ª—É–º")
            link = song.get("song_link", "–õ–∏–Ω–∫ –Ω–µ—Å—Ç")

            text = f"üéµ <b>{title}</b>\nüë§ {artist}\nüîó {link}"
            bot.edit_message_text(text, chat_id=message.chat.id, message_id=msg.message_id, parse_mode="HTML")
        else:
            bot.edit_message_text("üòî –ú–∞—ä–ª—É–º–∏ —Å—É—Ä—É–¥ —ë—Ñ—Ç –Ω–∞—à—É–¥.", chat_id=message.chat.id, message_id=msg.message_id)

    except Exception as e:
        bot.edit_message_text(f"‚ùå –•–∞—Ç–æ–≥”£: {e}", chat_id=message.chat.id, message_id=msg.message_id)

print("‚úÖ –ë–æ—Ç —Ñ–∞—ä–æ–ª —à—É–¥. –ë–∞—Ä–æ–∏ “õ–∞—Ç—ä –∫–∞—Ä–¥–∞–Ω CTRL+C")
bot.polling()
