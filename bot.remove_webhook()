from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    ContextTypes,
    filters,
)
import asyncio, random, datetime

# üîí TOKEN-–∏ —Ö—É–¥—Ä–æ –≥—É–∑–æ—Ä
TOKEN = "8238563485:AAHNLTZodPeXcl7YfjZqIqY6BpcPuP3QGXs"

# üëë ID-–∏ –∞–¥–º–∏–Ω
ADMIN_IDS = [8377215874]

# üì¶ –ú–∞“≥—Å—É–ª–æ—Ç“≥–æ
ITEMS = {
    1: {"name": "–§—É—Ç–±–æ–ª–∫–∞ Jazz", "price": 20, "desc": "–§—É—Ç–±–æ–ª–∫–∞–∏ —Å–∞–±—É–∫ –≤–∞ –∑–∞–º–æ–Ω–∞–≤”£ üéµ", "img": "tshirt.jpg"},
    2: {"name": "–ö–∞–ø—Å Jazz", "price": 12, "desc": "–ö–∞–ø—Å–∏ —É—Å–ª—É–±”£ –±–∞—Ä–æ–∏ “≥–∞—Ä —Ä”Ø–∑ üß¢", "img": "cap.jpg"},
    3: {"name": "–°—É–º–∫–∞ Jazz", "price": 25, "desc": "–°—É–º–∫–∞–∏ –±–æ—ç—ä—Ç–∏–º–æ–¥ –±–∞—Ä–æ–∏ —Å–∞—Ñ–∞—Ä üëú", "img": "bag.jpg"},
}

user_carts = {}
user_wishlist = {}
orders = []
all_users = set()

# ---------- –Å—Ä–¥–∞–º—á”£ ----------
async def send_typing(chat, text):
    await chat.send_action("typing")
    await asyncio.sleep(0.5)
    await chat.send_message(text)

# ---------- /start ----------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    all_users.add(user_id)
    chat = update.message.chat
    await send_typing(chat, "üé∂ –•—É—à –æ–º–∞–¥–µ–¥ –±–∞ Jazz Store!")
    await show_main_menu(chat, user_id)

# ---------- –ú–µ–Ω—é–∏ –∞—Å–æ—Å”£ ----------
async def show_main_menu(chat, user_id):
    buttons = [
        [
            InlineKeyboardButton("üõç –ö–∞—Ç–∞–ª–æ–≥", callback_data="open_catalog"),
            InlineKeyboardButton("‚ù§Ô∏è –î–∏–ª—Ö–æ“≥“≥–æ", callback_data="open_wishlist"),
        ],
        [
            InlineKeyboardButton("üõí –°–∞–±–∞–¥", callback_data="open_cart"),
            InlineKeyboardButton("üí¨ –ü—Ä–æ—Ñ–∏–ª–∏ –∞–¥–º–∏–Ω", url="tg://user?id=8377215874"),
        ],
        [InlineKeyboardButton("‚Ñπ –ú–∞—ä–ª—É–º–æ—Ç", callback_data="info")],
    ]
    if user_id in ADMIN_IDS:
        buttons.append([InlineKeyboardButton("üëë –ü–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω", callback_data="admin_panel")])
    await chat.send_message("–ú–µ–Ω—é–∏ –∞—Å–æ—Å”£:", reply_markup=InlineKeyboardMarkup(buttons))

# ---------- –ö–∞—Ç–∞–ª–æ–≥ ----------
async def catalog(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    if query:
        await query.answer()
        message = query.message
    else:
        message = update.message

    ITEMS_LIST = {
        1: "–§—É—Ç–±–æ–ª–∫–∞ Jazz",
        2: "–ö–∞–ø—Å Jazz",
        3: "–°—É–º–∫–∞ Jazz",
    }

    await message.reply_text("üõç –ö–∞—Ç–∞–ª–æ–≥–∏ –º–∞“≥—Å—É–ª–æ—Ç:\n")

    for i, name in ITEMS_LIST.items():
        buttons = [[
            InlineKeyboardButton("‚ûï –ë–∞ —Å–∞–±–∞–¥", callback_data=f"add_{i}"),
            InlineKeyboardButton("‚ù§Ô∏è –î–∏–ª—Ö–æ“≥", callback_data=f"wish_{i}")
        ]]
        await message.reply_text(f"{i}. {name}", reply_markup=InlineKeyboardMarkup(buttons))

    back_button = [[InlineKeyboardButton("‚¨ÖÔ∏è –ë–æ–∑–≥–∞—à—Ç", callback_data="back_main")]]
    await message.reply_text("–ë–∞—Ä–≥–∞—à—Ç–∞–Ω –±–∞ –º–µ–Ω—é:", reply_markup=InlineKeyboardMarkup(back_button))

# ---------- –ë–∞ —Å–∞–±–∞–¥ ----------
async def add_item(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    item_id = int(query.data.split("_")[1])
    user_id = query.from_user.id
    user_carts.setdefault(user_id, {})
    user_carts[user_id][item_id] = user_carts[user_id].get(item_id, 0) + 1
    await query.message.reply_text(f"‚úÖ {ITEMS[item_id]['name']} –±–∞ —Å–∞–±–∞–¥ –∏–ª–æ–≤–∞ —à—É–¥!")

# ---------- –ë–∞ –¥–∏–ª—Ö–æ“≥ ----------
async def add_wishlist(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    item_id = int(query.data.split("_")[1])
    user_id = query.from_user.id
    user_wishlist.setdefault(user_id, set()).add(item_id)
    await query.message.reply_text(f"üíñ {ITEMS[item_id]['name']} –±–∞ —Ä”Ø–π—Ö–∞—Ç–∏ –¥–∏–ª—Ö–æ“≥“≥–æ –∏–ª–æ–≤–∞ —à—É–¥!")

# ---------- –î–∏–ª—Ö–æ“≥“≥–æ ----------
async def open_wishlist(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    if query:
        await query.answer()
        message = query.message
        user_id = query.from_user.id
    else:
        message = update.message
        user_id = update.message.from_user.id

    items = user_wishlist.get(user_id, set())
    if not items:
        await message.reply_text("‚ù§Ô∏è –†”Ø–π—Ö–∞—Ç–∏ –¥–∏–ª—Ö–æ“≥“≥–æ —Ö–æ–ª–∏—Å—Ç.")
        return
    text = "‚ù§Ô∏è –ú–∞“≥—Å—É–ª–æ—Ç–∏ –¥”Ø—Å—Ç–¥–æ—à—Ç–∞:\n"
    for i in items:
        text += f"- {ITEMS[i]['name']} (${ITEMS[i]['price']})\n"
    buttons = [[
        InlineKeyboardButton("‚¨ÖÔ∏è –ë–æ–∑–≥–∞—à—Ç", callback_data="back_main"),
        InlineKeyboardButton("üõí –ë–∞ —Å–∞–±–∞–¥", callback_data="open_cart"),
    ]]
    await message.reply_text(text, reply_markup=InlineKeyboardMarkup(buttons))

# ---------- –°–∞–±–∞–¥ ----------
async def cart(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    if query:
        await query.answer()
        message = query.message
        user_id = query.from_user.id
    else:
        message = update.message
        user_id = update.message.from_user.id

    cart = user_carts.get(user_id, {})
    if not cart:
        await message.reply_text("üõí –°–∞–±–∞–¥ —Ö–æ–ª–∏—Å—Ç.")
        return
    text = "üõç –ú–∞“≥—Å—É–ª–æ—Ç–∏ —à—É–º–æ:\n"
    total = 0
    for item_id, qty in cart.items():
        subtotal = ITEMS[item_id]["price"] * qty
        total += subtotal
        text += f"- {ITEMS[item_id]['name']} x{qty} = ${subtotal}\n"
    text += f"\nüí∞ “≤–∞–º–∞–≥”£: ${total}"
    buttons = [
        [
            InlineKeyboardButton("üì¶ –§–∞—Ä–º–æ–∏—à –¥–æ–¥–∞–Ω", callback_data="checkout"),
            InlineKeyboardButton("üóëÔ∏è –¢–æ–∑–∞ –∫–∞—Ä–¥–∞–Ω", callback_data="clear_cart"),
        ],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ë–æ–∑–≥–∞—à—Ç", callback_data="back_main")],
    ]
    await message.reply_text(text, reply_markup=InlineKeyboardMarkup(buttons))

# ---------- Checkout ----------
async def checkout(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user = query.from_user
    user_id = user.id
    cart = user_carts.get(user_id, {})
    if not cart:
        await query.message.reply_text("üõí –°–∞–±–∞–¥ —Ö–æ–ª–∏—Å—Ç.")
        return
    total = sum(ITEMS[i]["price"] * q for i, q in cart.items())
    order_id = random.randint(10000, 99999)
    order_data = {
        "id": order_id,
        "user": user.username or user.first_name,
        "total": total,
        "items": cart,
        "time": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
    }
    orders.append(order_data)
    for admin in ADMIN_IDS:
        await context.bot.send_message(admin, f"üì¶ –§–∞—Ä–º–æ–∏—à–∏ –Ω–∞–≤ ‚Ññ{order_id} –∞–∑ @{order_data['user']}\nüí∞ ${total}")
    await query.message.reply_text(f"‚úÖ –§–∞—Ä–º–æ–∏—à–∏ —à—É–º–æ ‚Ññ{order_id} “õ–∞–±—É–ª —à—É–¥! üôå")

# ---------- –¢–æ–∑–∞ –∫–∞—Ä–¥–∞–Ω–∏ —Å–∞–±–∞–¥ ----------
async def clear_cart(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id
    user_carts[user_id] = {}
    await query.message.reply_text("üßπ –°–∞–±–∞–¥ —Ç–æ–∑–∞ —à—É–¥!")

# ---------- –ü–∞—ë–º“≥–æ–∏ broadcast ----------
async def relay(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    text = update.message.text
    if user_id in ADMIN_IDS:
        if context.user_data.get("broadcast_mode"):
            count = 0
            for u in all_users:
                try:
                    await context.bot.send_message(u, f"üì¢ –ü–∞—ë–º–∏ –∞–¥–º–∏–Ω:\n{text}")
                    count += 1
                except:
                    pass
            context.user_data["broadcast_mode"] = False
            await update.message.reply_text(f"‚úÖ –ü–∞—ë–º –±–∞ {count} –∫–æ—Ä–±–∞—Ä —Ñ–∏—Ä–∏—Å—Ç–æ–¥–∞ —à—É–¥.")
            return

# ---------- –ü–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω ----------
async def admin_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    buttons = [
        [
            InlineKeyboardButton("üì¶ –§–∞—Ä–º–æ–∏—à“≥–æ", callback_data="admin_orders"),
            InlineKeyboardButton("üìä –û–º–æ—Ä–∏ —É–º—É–º”£", callback_data="admin_stats"),
        ],
        [
            InlineKeyboardButton("üì® –ü–∞—ë–º –±–∞ “≥–∞–º–∞", callback_data="admin_broadcast"),
            InlineKeyboardButton("üßπ –ü–æ–∫—Å–æ–∑”£", callback_data="admin_clear"),
        ],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ë–æ–∑–≥–∞—à—Ç", callback_data="back_main")],
    ]
    await query.message.reply_text("üëë –ü–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω:", reply_markup=InlineKeyboardMarkup(buttons))

# ---------- –ë–æ–∑–≥–∞—à—Ç ----------
async def back_to_main(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    await show_main_menu(query.message.chat, query.from_user.id)

# ---------- Callback ----------
async def buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    data = update.callback_query.data
    if data == "open_catalog": await catalog(update, context)
    elif data.startswith("add_"): await add_item(update, context)
    elif data.startswith("wish_"): await add_wishlist(update, context)
    elif data == "open_wishlist": await open_wishlist(update, context)
    elif data == "open_cart": await cart(update, context)
    elif data == "clear_cart": await clear_cart(update, context)
    elif data == "checkout": await checkout(update, context)
    elif data == "info": await update.callback_query.message.reply_text("‚Ñπ Jazz Store ‚Äî –º–∞“ì–æ–∑–∞–∏ —Ä–∞—Å–º–∏–∏ Jazz üé∑")
    elif data == "admin_panel": await admin_panel(update, context)
    elif data == "admin_orders":
        if not orders:
            await update.callback_query.message.reply_text("üì¶ “≤–æ–ª–æ —è–≥–æ–Ω —Ñ–∞—Ä–º–æ–∏—à –Ω–µ—Å—Ç.")
        else:
            text = "üì¶ –§–∞—Ä–º–æ–∏—à“≥–æ:\n\n"
            for o in orders:
                text += f"‚Ññ{o['id']} - @{o['user']} - ${o['total']} - {o['time']}\n"
            await update.callback_query.message.reply_text(text)
    elif data == "admin_stats":
        await update.callback_query.message.reply_text(f"üìä –ö–æ—Ä–±–∞—Ä–æ–Ω: {len(all_users)}\nüõç –§–∞—Ä–º–æ–∏—à“≥–æ: {len(orders)}")
    elif data == "admin_clear":
        orders.clear()
        await update.callback_query.message.reply_text("üßπ “≤–∞–º–∞–∏ —Ñ–∞—Ä–º–æ–∏—à“≥–æ –ø–æ–∫ —à—É–¥–∞–Ω–¥.")
    elif data == "admin_broadcast":
        await update.callback_query.message.reply_text("üì¢ –ü–∞—ë–º–∏ —Ö—É–¥—Ä–æ –Ω–∞–≤–∏—Å–µ–¥ –±–∞—Ä–æ–∏ —Ñ–∏—Ä–∏—Å—Ç–æ–¥–∞–Ω –±–∞ “≥–∞–º–∞ –∫–æ—Ä–±–∞—Ä–æ–Ω:")
        context.user_data["broadcast_mode"] = True
    elif data == "back_main":
        await back_to_main(update, context)

# ---------- –ö–æ–º–∞–Ω–¥–∞“≥–æ–∏ –∏–ª–æ–≤–∞–≥”£ ----------
async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "üõç **Jazz Store ‚Äì –î–∞—Å—Ç—É—Ä**\n\n"
        "/catalog ‚Äì –¥–∏–¥–∞–Ω–∏ –º–∞“≥—Å—É–ª–æ—Ç\n"
        "/cart ‚Äì —Å–∞–±–∞–¥–∏ —à—É–º–æ\n"
        "/wishlist ‚Äì –¥–∏–ª—Ö–æ“≥“≥–æ–∏ —à—É–º–æ\n"
        "/info ‚Äì –º–∞—ä–ª—É–º–æ—Ç –¥–∞—Ä –±–æ—Ä–∞–∏ –º–∞“ì–æ–∑–∞\n"
        "/contact ‚Äì –±–æ –∞–¥–º–∏–Ω —Ç–∞–º–æ—Å –≥–∏—Ä–∏—Ñ—Ç–∞–Ω\n"
        "/admin ‚Äì –±–∞—Ä–æ–∏ –∞–¥–º–∏–Ω“≥–æ\n"
    )
    await update.message.reply_text(text)

async def catalog_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await catalog(update, context)

async def cart_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await cart(update, context)

async def wishlist_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await open_wishlist(update, context)

async def info_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("‚Ñπ Jazz Store ‚Äî –º–∞“ì–æ–∑–∞–∏ —Ä–∞—Å–º–∏–∏ –º–∞“≥—Å—É–ª–æ—Ç–∏ –±—Ä–µ–Ω–¥–∏–∏ Jazz üé∑")

async def contact_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("üí¨ –ë–∞—Ä–æ–∏ —Å–∞–≤–æ–ª“≥–æ –≤–∞ —Ñ–∞—Ä–º–æ–∏—à“≥–æ –Ω–∞–≤–∏—Å–µ–¥ –±–∞ @Admin")

async def admin_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.from_user.id in ADMIN_IDS:
        fake_query = type("Q", (), {"data": "admin_panel", "from_user": update.message.from_user, "answer": lambda: None, "message": update.message})()
        await admin_panel(Update(callback_query=fake_query), context)
    else:
        await update.message.reply_text("üö´ –ò–Ω —Ñ–∞—Ä–º–æ–Ω —Ç–∞–Ω“≥–æ –±–∞—Ä–æ–∏ –∞–¥–º–∏–Ω –∞—Å—Ç.")

# ---------- –°–æ—Ö—Ç–∞–Ω–∏ –±–æ—Ç ----------
def main():
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CommandHandler("catalog", catalog_command))
    app.add_handler(CommandHandler("cart", cart_command))
    app.add_handler(CommandHandler("wishlist", wishlist_command))
    app.add_handler(CommandHandler("info", info_command))
    app.add_handler(CommandHandler("contact", contact_command))
    app.add_handler(CommandHandler("admin", admin_command))
    app.add_handler(CallbackQueryHandler(buttons))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, relay))
    print("‚úÖ Jazz Store –ø—É—Ä—Ä–∞ —Ñ–∞—ä–æ–ª —à—É–¥!")
    app.run_polling()

if __name__ == "__main__":
    main()
