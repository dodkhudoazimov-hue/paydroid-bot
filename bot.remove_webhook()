from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, ContextTypes, filters
import asyncio, random, datetime

TOKEN = "8238563485:AAHNLTZodPeXcl7YfjZqIqY6BpcPuP3QGXs"
ADMIN_IDS = [8377215874]
ADMIN_USERNAME = "MARZ_X5"  # <== Ð±Ðµ @ Ð½Ð°Ð²Ð¸Ñ

ITEMS = {
    1: {"name": "Ð¤ÑƒÑ‚Ð±Ð¾Ð»ÐºÐ° Jazz", "price": 20, "desc": "Ð¤ÑƒÑ‚Ð±Ð¾Ð»ÐºÐ°Ð¸ ÑÐ°Ð±ÑƒÐº Ð²Ð° Ð·Ð°Ð¼Ð¾Ð½Ð°Ð²Ó£ ðŸŽµ", "img": "tshirt.jpg"},
    2: {"name": "ÐšÐ°Ð¿Ñ Jazz", "price": 12, "desc": "ÐšÐ°Ð¿ÑÐ¸ ÑƒÑÐ»ÑƒÐ±Ó£ Ð±Ð°Ñ€Ð¾Ð¸ Ò³Ð°Ñ€ Ñ€Ó¯Ð· ðŸ§¢", "img": "cap.jpg"},
    3: {"name": "Ð¡ÑƒÐ¼ÐºÐ° Jazz", "price": 25, "desc": "Ð¡ÑƒÐ¼ÐºÐ°Ð¸ Ð±Ð¾ÑÑŠÑ‚Ð¸Ð¼Ð¾Ð´ Ð±Ð°Ñ€Ð¾Ð¸ ÑÐ°Ñ„Ð°Ñ€ ðŸ‘œ", "img": "bag.jpg"}
}

user_carts, user_wishlist, orders = {}, {}, []
all_users = set()

# ---------- ÐÑ€Ð´Ð°Ð¼Ñ‡Ó£ ----------
async def send_typing(chat, text):
    await chat.send_chat_action("typing")
    await asyncio.sleep(0.5)
    await chat.send_message(text)

# ---------- /start ----------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    all_users.add(user_id)
    chat = update.message.chat

    await send_typing(chat, "ðŸŽ¶ Ð¥ÑƒÑˆ Ð¾Ð¼Ð°Ð´ÐµÐ´ Ð±Ð° **Jazz Store!**")

    buttons = [
        [
            InlineKeyboardButton("ðŸ› ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³", callback_data="open_catalog"),
            InlineKeyboardButton("â¤ï¸ Ð”Ð¸Ð»Ñ…Ð¾Ò³Ò³Ð¾", callback_data="open_wishlist")
        ],
        [
            InlineKeyboardButton("ðŸ›’ Ð¡Ð°Ð±Ð°Ð´", callback_data="open_cart"),
            InlineKeyboardButton("ðŸ’¬ Ð¡ÑƒÒ³Ð±Ð°Ñ‚ Ð±Ð¾ Ð°Ð´Ð¼Ð¸Ð½", url=f"https://t.me/{ADMIN_USERNAME}")
        ],
        [InlineKeyboardButton("â„¹ ÐœÐ°ÑŠÐ»ÑƒÐ¼Ð¾Ñ‚", callback_data="info")]
    ]

    if user_id in ADMIN_IDS:
        buttons.append([InlineKeyboardButton("ðŸ‘‘ ÐŸÐ°Ð½ÐµÐ»Ð¸ Ð°Ð´Ð¼Ð¸Ð½", callback_data="admin_panel")])

    await chat.send_message("ÐœÐµÐ½ÑŽÐ¸ Ð°ÑÐ¾ÑÓ£:", reply_markup=InlineKeyboardMarkup(buttons))

# ---------- ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³ ----------
async def catalog(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    for k, v in ITEMS.items():
        with open(v["img"], "rb") as photo:
            buttons = [[
                InlineKeyboardButton("âž• Ð‘Ð° ÑÐ°Ð±Ð°Ð´", callback_data=f"add_{k}"),
                InlineKeyboardButton("â¤ï¸ Ð”Ð¸Ð»Ñ…Ð¾Ò³", callback_data=f"wish_{k}")
            ]]
            await query.message.reply_photo(
                photo=photo,
                caption=f"{v['name']} - ${v['price']}\n{v['desc']}",
                reply_markup=InlineKeyboardMarkup(buttons)
            )
    await query.message.reply_text(
        "â¬…ï¸ Ð‘Ð°Ñ€Ð¾Ð¸ Ð±Ð¾Ð·Ð³Ð°ÑˆÑ‚ Ð±Ð° Ð¼ÐµÐ½ÑŽ Ð·ÐµÑ€ ÐºÑƒÐ½ÐµÐ´:",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("â¬…ï¸ Ð‘Ð¾Ð·Ð³Ð°ÑˆÑ‚", callback_data="back_main")]])
    )

# ---------- Ð‘Ð° ÑÐ°Ð±Ð°Ð´ ----------
async def add_item(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    item_id = int(query.data.split("_")[1])
    user_id = query.from_user.id
    user_carts.setdefault(user_id, {})
    user_carts[user_id][item_id] = user_carts[user_id].get(item_id, 0) + 1
    await query.message.reply_text(f"âœ… {ITEMS[item_id]['name']} Ð±Ð° ÑÐ°Ð±Ð°Ð´ Ð¸Ð»Ð¾Ð²Ð° ÑˆÑƒÐ´!")

# ---------- Ð‘Ð° Ð´Ð¸Ð»Ñ…Ð¾Ò³ ----------
async def add_wishlist(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    item_id = int(query.data.split("_")[1])
    user_id = query.from_user.id
    user_wishlist.setdefault(user_id, set()).add(item_id)
    await query.message.reply_text(f"ðŸ’– {ITEMS[item_id]['name']} Ð±Ð° Ñ€Ó¯Ð¹Ñ…Ð°Ñ‚Ð¸ Ð´Ð¸Ð»Ñ…Ð¾Ò³Ò³Ð¾ Ð¸Ð»Ð¾Ð²Ð° ÑˆÑƒÐ´!")

# ---------- Ð¡Ð°Ð±Ð°Ð´ ----------
async def cart(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id
    cart = user_carts.get(user_id, {})
    if not cart:
        await query.message.reply_text("ðŸ›’ Ð¡Ð°Ð±Ð°Ð´ Ñ…Ð¾Ð»Ð¸ÑÑ‚.")
        return
    text = "ðŸ› ÐœÐ°Ò³ÑÑƒÐ»Ð¾Ñ‚Ð¸ ÑˆÑƒÐ¼Ð¾:\n"
    total = 0
    for item_id, qty in cart.items():
        subtotal = ITEMS[item_id]["price"] * qty
        total += subtotal
        text += f"- {ITEMS[item_id]['name']} x{qty} = ${subtotal}\n"
    text += f"\nðŸ’° Ò²Ð°Ð¼Ð°Ð³Ó£: ${total}"

    buttons = [
        [
            InlineKeyboardButton("ðŸ“¦ Ð¤Ð°Ñ€Ð¼Ð¾Ð¸Ñˆ Ð´Ð¾Ð´Ð°Ð½", callback_data="checkout"),
            InlineKeyboardButton("ðŸ—‘ï¸ Ð¢Ð¾Ð·Ð° ÐºÐ°Ñ€Ð´Ð°Ð½", callback_data="clear_cart")
        ],
        [InlineKeyboardButton("â¬…ï¸ Ð‘Ð¾Ð·Ð³Ð°ÑˆÑ‚", callback_data="back_main")]
    ]
    await query.message.reply_text(text, reply_markup=InlineKeyboardMarkup(buttons))

# ---------- Checkout ----------
async def checkout(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user = query.from_user
    user_id = user.id
    cart = user_carts.get(user_id, {})
    if not cart:
        await query.message.reply_text("ðŸ›’ Ð¡Ð°Ð±Ð°Ð´ Ñ…Ð¾Ð»Ð¸ÑÑ‚.")
        return

    total = sum(ITEMS[i]["price"] * q for i, q in cart.items())
    order_id = random.randint(10000, 99999)
    orders.append({
        "id": order_id,
        "user": user.username or user.first_name,
        "total": total,
        "time": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    })

    for admin in ADMIN_IDS:
        await context.bot.send_message(admin, f"ðŸ“¦ Ð¤Ð°Ñ€Ð¼Ð¾Ð¸ÑˆÐ¸ Ð½Ð°Ð² â„–{order_id} Ð°Ð· @{user.username}\nðŸ’° ${total}")

    await query.message.reply_text(f"âœ… Ð¤Ð°Ñ€Ð¼Ð¾Ð¸ÑˆÐ¸ ÑˆÑƒÐ¼Ð¾ â„–{order_id} Ò›Ð°Ð±ÑƒÐ» ÑˆÑƒÐ´! ðŸ™Œ")

# ---------- Ð¢Ð¾Ð·Ð° ÐºÐ°Ñ€Ð´Ð°Ð½Ð¸ ÑÐ°Ð±Ð°Ð´ ----------
async def clear_cart(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_carts[query.from_user.id] = {}
    await query.message.reply_text("ðŸ§¹ Ð¡Ð°Ð±Ð°Ð´ Ñ‚Ð¾Ð·Ð° ÑˆÑƒÐ´!")

# ---------- Relay ----------
async def relay(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    text = update.message.text

    # ÐŸÐ°Ñ‘Ð¼ Ð±Ð° Ò³Ð°Ð¼Ð°
    if user_id in ADMIN_IDS and context.user_data.get("broadcast_mode"):
        sent = 0
        for u in all_users:
            try:
                await context.bot.send_message(u, f"ðŸ“¢ ÐŸÐ°Ñ‘Ð¼Ð¸ Ð°Ð´Ð¼Ð¸Ð½:\n\n{text}")
                sent += 1
            except:
                pass
        context.user_data["broadcast_mode"] = False
        await update.message.reply_text(f"âœ… ÐŸÐ°Ñ‘Ð¼ Ð±Ð° {sent} ÐºÐ¾Ñ€Ð±Ð°Ñ€ Ñ„Ð¸Ñ€Ð¸ÑÑ‚Ð¾Ð´Ð° ÑˆÑƒÐ´.")
        return

# ---------- ÐŸÐ°Ð½ÐµÐ»Ð¸ Ð°Ð´Ð¼Ð¸Ð½ ----------
async def admin_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    buttons = [
        [
            InlineKeyboardButton("ðŸ“¦ Ð¤Ð°Ñ€Ð¼Ð¾Ð¸ÑˆÒ³Ð¾", callback_data="admin_orders"),
            InlineKeyboardButton("ðŸ“Š ÐžÐ¼Ð¾Ñ€Ð¸ ÑƒÐ¼ÑƒÐ¼Ó£", callback_data="admin_stats")
        ],
        [
            InlineKeyboardButton("ðŸ“¨ ÐŸÐ°Ñ‘Ð¼ Ð±Ð° Ò³Ð°Ð¼Ð°", callback_data="admin_broadcast"),
            InlineKeyboardButton("ðŸ§¹ ÐŸÐ¾ÐºÑÐ¾Ð·Ó£", callback_data="admin_clear")
        ],
        [InlineKeyboardButton("â¬…ï¸ Ð‘Ð¾Ð·Ð³Ð°ÑˆÑ‚", callback_data="back_main")]
    ]
    await query.message.reply_text("ðŸ‘‘ ÐŸÐ°Ð½ÐµÐ»Ð¸ Ð°Ð´Ð¼Ð¸Ð½:", reply_markup=InlineKeyboardMarkup(buttons))

# ---------- Ð‘Ð¾Ð·Ð³Ð°ÑˆÑ‚ ----------
async def back_to_main(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id

    buttons = [
        [
            InlineKeyboardButton("ðŸ› ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³", callback_data="open_catalog"),
            InlineKeyboardButton("â¤ï¸ Ð”Ð¸Ð»Ñ…Ð¾Ò³Ò³Ð¾", callback_data="open_wishlist")
        ],
        [
            InlineKeyboardButton("ðŸ›’ Ð¡Ð°Ð±Ð°Ð´", callback_data="open_cart"),
            InlineKeyboardButton("ðŸ’¬ Ð¡ÑƒÒ³Ð±Ð°Ñ‚ Ð±Ð¾ Ð°Ð´Ð¼Ð¸Ð½", url=f"https://t.me/{ADMIN_USERNAME}")
        ],
        [InlineKeyboardButton("â„¹ ÐœÐ°ÑŠÐ»ÑƒÐ¼Ð¾Ñ‚", callback_data="info")]
    ]

    if user_id in ADMIN_IDS:
        buttons.append([InlineKeyboardButton("ðŸ‘‘ ÐŸÐ°Ð½ÐµÐ»Ð¸ Ð°Ð´Ð¼Ð¸Ð½", callback_data="admin_panel")])

    await query.message.reply_text("ÐœÐµÐ½ÑŽÐ¸ Ð°ÑÐ¾ÑÓ£:", reply_markup=InlineKeyboardMarkup(buttons))

# ---------- Callback ----------
async def buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    data = update.callback_query.data
    if data == "open_catalog": await catalog(update, context)
    elif data.startswith("add_"): await add_item(update, context)
    elif data.startswith("wish_"): await add_wishlist(update, context)
    elif data == "open_wishlist":
        await update.callback_query.message.reply_text("â¤ï¸ Ð Ó¯Ð¹Ñ…Ð°Ñ‚Ð¸ Ð´Ð¸Ð»Ñ…Ð¾Ò³Ò³Ð¾ Ñ…Ð¾Ð»Ð¸ÑÑ‚.")
    elif data == "open_cart": await cart(update, context)
    elif data == "clear_cart": await clear_cart(update, context)
    elif data == "checkout": await checkout(update, context)
    elif data == "info":
        await update.callback_query.message.reply_text("â„¹ Jazz Store â€” Ð¼Ð°Ò“Ð¾Ð·Ð°Ð¸ Ñ€Ð°ÑÐ¼Ð¸Ð¸ Jazz ðŸŽ·")
    elif data == "admin_panel": await admin_panel(update, context)
    elif data == "admin_orders":
        if not orders:
            await update.callback_query.message.reply_text("ðŸ“¦ Ò²Ð¾Ð»Ð¾ ÑÐ³Ð¾Ð½ Ñ„Ð°Ñ€Ð¼Ð¾Ð¸Ñˆ Ð½ÐµÑÑ‚.")
        else:
            text = "\n".join([f"â„–{o['id']} - @{o['user']} - ${o['total']} - {o['time']}" for o in orders])
            await update.callback_query.message.reply_text(f"ðŸ“¦ Ð¤Ð°Ñ€Ð¼Ð¾Ð¸ÑˆÒ³Ð¾:\n{text}")
    elif data == "admin_stats":
        await update.callback_query.message.reply_text(
            f"ðŸ“Š ÐšÐ¾Ñ€Ð±Ð°Ñ€Ð¾Ð½: {len(all_users)}\nðŸ› Ð¤Ð°Ñ€Ð¼Ð¾Ð¸ÑˆÒ³Ð¾: {len(orders)}"
        )
    elif data == "admin_clear":
        orders.clear()
        await update.callback_query.message.reply_text("ðŸ§¹ Ò²Ð°Ð¼Ð°Ð¸ Ñ„Ð°Ñ€Ð¼Ð¾Ð¸ÑˆÒ³Ð¾ Ð¿Ð¾Ðº ÑˆÑƒÐ´Ð°Ð½Ð´.")
    elif data == "admin_broadcast":
        await update.callback_query.message.reply_text("ðŸ“¢ ÐŸÐ°Ñ‘Ð¼Ð¸ Ñ…ÑƒÐ´Ñ€Ð¾ Ð½Ð°Ð²Ð¸ÑÐµÐ´ Ð±Ð°Ñ€Ð¾Ð¸ Ñ„Ð¸Ñ€Ð¸ÑÑ‚Ð¾Ð´Ð°Ð½ Ð±Ð° Ò³Ð°Ð¼Ð°.")
        context.user_data["broadcast_mode"] = True
    elif data == "back_main": await back_to_main(update, context)

# ---------- Ð¡Ð¾Ñ…Ñ‚Ð°Ð½Ð¸ Ð±Ð¾Ñ‚ ----------
app = ApplicationBuilder().token(TOKEN).build()
app.add_handler(CommandHandler("start", start))
app.add_handler(CallbackQueryHandler(buttons))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, relay))

print("âœ… Jazz Store Ð¿ÑƒÑ€Ñ€Ð° Ñ„Ð°ÑŠÐ¾Ð» ÑˆÑƒÐ´!")
app.run_polling()
